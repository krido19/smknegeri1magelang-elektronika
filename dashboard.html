<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Dashboard Akses Gerbang RFID (Realtime)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    @media print { .no-print { display:none; } }
    body { background:#f7f7f7; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="m-0">üìä Log Akses Gerbang RFID (Realtime)</h3>
    <div class="no-print">
      <input id="searchInput" class="form-control" style="width:220px" placeholder="Cari UID / Pemilik / Gate">
    </div>
  </div>

  <div class="mb-3 no-print d-flex gap-2">
    <button class="btn btn-success" onclick="window.print()">üñ®Ô∏è Cetak</button>
    <button class="btn btn-warning" onclick="exportCSV()">üìÇ Export CSV</button>
    <span id="statusBadge" class="badge text-bg-secondary align-self-center">Menghubungkan...</span>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover m-0" id="logTable">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Waktu</th>
              <th>UID</th>
              <th>Pemilik</th>
              <th>Gate</th>
              <th>Status</th>
              <th>Device IP</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, onChildAdded, get, child, query, limitToLast, orderByKey } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  const firebaseConfig = {
      apiKey: "AIzaSyCK41p3Ufc-KFTMGhdzwSKbxDiWP2enjc0",
      authDomain: "gerbang-61ad4.firebaseapp.com",
      databaseURL: "https://gerbang-61ad4-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "gerbang-61ad4",
      storageBucket: "gerbang-61ad4.firebasestorage.app",
      messagingSenderId: "130881959289",
      appId: "1:130881959289:web:a4c68dbef6067c90aaeba8",
      measurementId: "G-311S91E2HM"
    };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const tbody = document.getElementById('tbody');
  const statusBadge = document.getElementById('statusBadge');
  const searchInput = document.getElementById('searchInput');

  // cache pemilik kartu
  const cardCache = new Map();
  let rowCount = 0;

  function fmtTime(ts) {
    // Jika ts adalah epoch millis, render lokal time
    // Kalau tidak ada ts, pakai Date.now()
    const d = ts ? new Date(ts) : new Date();
    return d.toLocaleString();
  }

  function matchesFilter(row) {
    const q = (searchInput.value || "").toLowerCase();
    if (!q) return true;
    return (
      row.uid.toLowerCase().includes(q) ||
      (row.owner || "").toLowerCase().includes(q) ||
      (row.gateId || "").toLowerCase().includes(q) ||
      (row.status || "").toLowerCase().includes(q) ||
      (row.deviceIp || "").toLowerCase().includes(q)
    );
  }

  function renderRow(row) {
    if (!matchesFilter(row)) return;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${++rowCount}</td>
      <td>${fmtTime(row.ts)}</td>
      <td>${row.uid || ""}</td>
      <td>${row.owner || ""}</td>
      <td>${row.gateId || ""}</td>
      <td>${row.status || ""}</td>
      <td>${row.deviceIp || ""}</td>
    `;
    tbody.prepend(tr); // terbaru di atas
  }

  async function resolveOwner(uid) {
    if (cardCache.has(uid)) return cardCache.get(uid);
    const snap = await get(child(ref(db), `cards/${uid}/owner`));
    const owner = snap.exists() ? snap.val() : "";
    cardCache.set(uid, owner);
    return owner;
  }

  // Auth anonim lalu subscribe log terakhir (mis. 200 terakhir)
  signInAnonymously(auth).catch(console.error);

  onAuthStateChanged(auth, (user) => {
    if (user) {
      statusBadge.className = "badge text-bg-success";
      statusBadge.textContent = "Tersambung";
      const logsRef = query(ref(db, "accessLogs"), orderByKey(), limitToLast(200));
      onChildAdded(logsRef, async (snap) => {
        const data = snap.val() || {};
        if (!data.owner && data.uid) {
          data.owner = await resolveOwner(data.uid);
        }
        renderRow(data);
      });
    } else {
      statusBadge.className = "badge text-bg-secondary";
      statusBadge.textContent = "Terputus";
    }
  });

  // Filter realtime
  searchInput.addEventListener('input', () => {
    // re-render cepat: rebuild tbody dari cache DOM sederhana
    const rows = Array.from(tbody.querySelectorAll('tr')).reverse(); // kronologi
    tbody.innerHTML = "";
    rowCount = 0;
    rows.forEach(tr => {
      const cols = tr.querySelectorAll('td');
      const row = {
        ts: new Date(cols[1].textContent).getTime(),
        uid: cols[2].textContent,
        owner: cols[3].textContent,
        gateId: cols[4].textContent,
        status: cols[5].textContent,
        deviceIp: cols[6].textContent
      };
      if (matchesFilter(row)) {
        const tr2 = document.createElement('tr');
        tr2.innerHTML = tr.innerHTML.replace(/^<td>\d+<\/td>/, `<td>${++rowCount}</td>`);
        tbody.prepend(tr2);
      }
    });
  });

  // Export CSV
  window.exportCSV = function() {
    const rows = [["No","Waktu","UID","Pemilik","Gate","Status","Device IP"]];
    Array.from(tbody.querySelectorAll('tr')).forEach((tr, i) => {
      const tds = tr.querySelectorAll('td');
      rows.push([i+1, tds[1].textContent, tds[2].textContent, tds[3].textContent, tds[4].textContent, tds[5].textContent, tds[6].textContent]);
    });
    const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type: "text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = "log_akses.csv"; a.click();
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>

